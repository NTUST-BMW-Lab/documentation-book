# <center><i class="fa fa-edit"></i> PHY STUB SOURCE CODE TRACING #2 </center>
###### tags: `Internship` `Daily Report` `PHY STUB`
:::success
**Learning Objective** :heavy_check_mark: 
* Learn about configuration messages:
    * PARAM
    * CONFIG
    * START
    * STOP
    * ERROR
* Learn about SLOT messages:
    * DL_TTI.response
    * ERROR.indication
    * CRC.indication
    * SRS.indication
    * RACH.indication
:::
:::info
**Resources** :package: 
1. [5G FAPI: PHY API Specification](https://www.smallcellforum.org/work-items/fapi/#:~:text=The%20latest%20FAPI%20specifications%20are,(P5)%20interface%20%5BSCF222%5D)
2. [O-DU l2 source code](https://gerrit.o-ran-sc.org/r/admin/repos/o-du/l2,general)
:::
----
Outline:

----

This study notes is the next study notes of [PHY STUB SOURCE CODE TRACING](/oKjTAGKiQCGu6wa4zqbV-w). This will include another message but briefly described.
# Source Code Mapping
:::warning
O-DU l2 git repository:
> https://gerrit.o-ran-sc.org/r/admin/repos/o-du/l2,general
:::

## CRC.indication
### 1. `l1BuildAndSendCrcInd` (Main/Starting function)
> File Directory : .\odu_l2\l2\src\phy_stub\phy_stub_msg_hdl.c

:::success
**Specific Information**
This function is generated by l1 (PHY Layer) and send the CRC.indication message to l2. This function is the main/starting function to generate this message.
:::

:::info

**Declaration**
```c
uint16_t l1BuildAndSendCrcInd(uint16_t slot, 
                              uint16_t sfn, 
                              fapi_ul_pusch_pdu_t puschPdu)

```

**Functionality**
Processes message from PHY

**Parameters**

| Field                 | Type     | Description|
| --------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| sfn                   | uint16_t | SFN (System Frame Network). Value: 0->1023|
| slot                  | uint16_t | Slot. Value: 0->159|
|puschPdu|fapi_ul_pusch_pdu_t|puschPdu is a `fapi_ul_pusch_pdu_t` type data. `fapi_ul_pusch_pdu_t` is a struct. You can find the details of this struct on ==[5G FAPI: PHY API Spec Ver. 222.10.06](https://www.smallcellforum.org/work-items/fapi/#:~:text=The%20latest%20FAPI%20specifications%20are,(P5)%20interface%20%5BSCF222%5D)== Table 3-105 on PUSCH PDU section.|

**Return Value**
* ROK    :arrow_right: success
* RFAILED    :arrow_right: failure

:::

### 2. `procPhyMessages` (function)
> File Directory : .\odu_l2\l2\src\5gnrmac\lwr_mac_handle_phy.c

:::success
**Specific Information**
This function will process the message from PHY.
:::

:::info

**Declaration**
```c
void procPhyMessages(uint16_t msgType, 
                     uint32_t msgSize, 
                     void *msg)
```

**Functionality**
Processes message from PHY

**Parameters**

| Parameter | Type | Description |
| --------- | ---- | ----------- |
|msgType|uint16_t|This parameter defines the message type based on the message tye that we want to send|
|msgSize|uint32_t|The size of the message (`fapi_crc_indication_t` struct) |
|*msg |  | Pointer to the received message from the PHY layer|

**Return Value**
* ROK    :arrow_right: success
* RFAILED    :arrow_right: failure
:::

### 3. `procCrcInd` (Function)
> File Directory : .\odu_l2\l2\src\5gnrmac\lwr_mac_handle_phy.c

:::success
**General Information**
This function will handle the CRC Indication from PHY and sends to MAC
:::

:::info
**Declaration**
```c
uint8_t procCrcInd(fapi_crc_ind_t  *fapiCrcInd)
```
**Functionality**
Handles Rach indication from PHY and sends to MAC

**Parameters**
| Field                 | Type     | Description|
| --------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| *fapiCrcInd                   | fapi_crc_indication_t | fapi_crc_indication_t message pointer|

**Return Value**
* ROK    :arrow_right: success
* RFAILED    :arrow_right: failure
:::

### Message Sequence (MSC)
:::success
![](https://hackmd.io/_uploads/HyuD4FqY3.png)

:::
## SRS.indication
This message is not yet defined or developed based on the source code that I used.

## RACH.indication
### 1. `l1BuildAndSendRachInd` (Main/Starting function)
> File Directory : .\odu_l2\l2\src\phy_stub\phy_stub_msg_hdl.c

:::success
**Specific Information**
This function is generated by l1 (PHY Layer) and send the RACH.indication message to l2. This function is the main/starting function to generate this message.
:::

:::info

**Declaration**
```c
uint16_t l1BuildAndSendRachInd(uint16_t slot, 
                               uint16_t sfn, 
                               uint8_t raPreambleIdx)

```

**Functionality**
 Builds and Sends RACH indication to MAC

**Parameters**

| Field                 | Type     | Description|
| --------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| sfn                   | uint16_t | SFN (System Frame Network). Value: 0->1023|
| slot                  | uint16_t | Slot. Value: 0->159|
|raPreambleIdx|uint8_t||

**Return Value**
* ROK    :arrow_right: success
* RFAILED    :arrow_right: failure

:::

### 2. `procPhyMessages` (function)
> File Directory : .\odu_l2\l2\src\5gnrmac\lwr_mac_handle_phy.c

:::success
**Specific Information**
This function will process the message from PHY.
:::

:::info

**Declaration**
```c
void procPhyMessages(uint16_t msgType, 
                     uint32_t msgSize, 
                     void *msg)
```

**Functionality**
Processes message from PHY

**Parameters**

| Parameter | Type | Description |
| --------- | ---- | ----------- |
|msgType|uint16_t|This parameter defines the message type based on the message tye that we want to send|
|msgSize|uint32_t|The size of the message (`fapi_rach_indication_t` struct) |
|*msg |  | Pointer to the received message from the PHY layer|

**Return Value**
* ROK    :arrow_right: success
* RFAILED    :arrow_right: failure
:::

### 3. `procRachInd` (Function)
> File Directory : .\odu_l2\l2\src\5gnrmac\lwr_mac_handle_phy.c

:::success
**General Information**
This function will handle the RACH Indication from PHY and sends to MAC
:::

:::info
**Declaration**
```c
uint8_t procRachInd(fapi_rach_indication_t  *fapiRachInd)
```
**Functionality**
Handles Rach indication from PHY and sends to MAC

**Parameters**
| Field                 | Type     | Description|
| --------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| *fapiRachInd                   | fapi_rach_indication_t | fapi_rach_indication_t message pointer|

**Return Value**
* ROK    :arrow_right: success
* RFAILED    :arrow_right: failure
:::



### Message Sequence (MSC)
:::success
![](https://hackmd.io/_uploads/BJg6tF5K3.png)
:::
## PARAM.request
### 1. `l1HdlParamReq` (Ending Procedure)
> File Directory : .\odu_l2\l2\src\phy_stub\phy_stub_msg_hdl.c

:::success
**Specific Information**
This function is the ending procedure that will handle the PARAM.request message from l2 (MAC). This function will automatically call [`l1BldAndSndParamRsp`](#1-l1BldAndSndParamRsp-MainStarting-function) to initiate the [PARAM.response](#PARAMresponse) message.
:::

:::info

**Declaration**
```c
void l1HdlParamReq(uint32_t msgLen, 
                   void *msg)
```

**Functionality**
Handles param request received from MAC

**Parameters**

| Field                 | Type     | Description|
| --------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
|msgLen| uint32_t | Message Length|
| *msg |  | Param request message pointer|


**Return Value**
None

:::

### 2. `l1ProcessFapiRequest` (procedure)
> File Directory :.\odu_l2\l2\src\phy_stub\phy_stub_msg_hdl.c

:::success
**Specific Information**
Basically this procedure is to choose what is the next procedure to handle  the message based on the msgType that we input on this procedure. Based on the PARAM.request message, this procedure will call `l1HdlParamReq` procedure.
:::

:::info
**Declaration**
```c
void l1ProcessFapiRequest(uint8_t msgType, 
                          uint32_t msgLen, 
                          void *msg)
```
**Functionality**
Receives message from MAC and calls handler

**Parameters**
| Parameter | Type | Description |
| --------- | ---- | ----------- |
|msgType|uint8_t|This parameter defines the message type based on the header.|
|msgLen|uint32_t|The length of the message |
|*msg |  | Message pointer|

**Return Value**
None

:::

### 3. `lwr_mac_procParamReqEvt`
> File Directory D.\odu_l2\l2\src\5gnrmac\lwr_mac_fsm.c

:::success
**Specific Information**
This procedure will send FAPI Param req to PHY and will call [`l1ProcessFapiRequest`](#2-l1ProcessFapiRequest-procedure) procedure
:::

:::info
**Declaration**
```c
uint8_t lwr_mac_procParamReqEvt(void *msg)
```
**Functionality**
Sends FAPI Param req to PHY

**Parameters**
| Parameter | Type | Description |
| --------- | ---- | ----------- |
|*msg|pointer|This is a pointer to a message|

**Return Value**
* ROK    :arrow_right: success
* RFAILED    :arrow_right: failure

:::


### Message Sequence (MSC)
:::success
![](https://hackmd.io/_uploads/S1I1cq9Kh.png)

:::
## PARAM.response
### 1. `l1BldAndSndParamRsp` (Main/Starting function)
> File Directory : .\odu_l2\l2\src\phy_stub\phy_stub_msg_hdl.c

:::success
**Specific Information**
This function is the starting function of this message. This function is automatically called by [`l1HdlParamReq`](#1-l1HdlParamReq-Ending-Procedure)
:::

:::info

**Declaration**
```c
S16 l1BldAndSndParamRsp(void *msg)
```

**Functionality**
Builds and sends param response to MAC CL

**Parameters**

| Field                 | Type     | Description|
| --------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| *msg |  | Param response message pointer|


**Return Value**
None
:::


### 2. `fillTlvs` (Procedure)
> File Directory : .\odu_l2\l2\src\5gnrmac\lwr_mac_fsm.c

:::success
**Specific Information**
This function will fill the TLVs based on the procedure/message that we want to send. 
:::

:::info

**Declaration**
```c
void fillTlvs(fapi_uint32_tlv_t *tlv, 
              uint16_t tag, 
              uint16_t length,
              uint32_t value, 
              uint32_t *msgLen)
```

**Functionality**
Fills FAPI PARAM response message header

**Parameters**

| Field | Type | Description                    |
| ----- | ---- | ------------------------------ |
|*tlv|fapi_uint32_tlv_t|Pointer to `fapi_uint32_tlv_t` struct|
|tag|uint16_t|                                |
|length|uint16_t|                                |
|value|uint32_t|                                |
| *msgLen  |uint32_t| Length of the message|

**Return Value**
None
:::

### 3. `procPhyMessages` (function)
> File Directory : .\odu_l2\l2\src\5gnrmac\lwr_mac_handle_phy.c

:::success
**Specific Information**
This function will process the message from PHY. This function is called when we already fill the parameters for `l1bBldAndSndParamRsp` function. 
:::

:::info

**Declaration**
```c
void procPhyMessages(uint16_t msgType, 
                     uint32_t msgSize, 
                     void *msg)
```

**Functionality**
Processes message from PHY

**Parameters**

| Parameter | Type | Description |
| --------- | ---- | ----------- |
|msgType|uint16_t|This parameter defines the message type based on the header that we already filled on the message type
|msgSize|uint32_t|The size of the message |
|*msg |  | Pointer to the received message from the PHY layer|

**Return Value**
* ROK    :arrow_right: success
* RFAILED    :arrow_right: failure

:::
### 4. `sendToLowerMac` (procedure)
> File Directory : .\odu_l2\l2\src\5gnrmac\lwr_mac_fsm.c

:::success
**Specific Information**
This function will send the message to the LowerMac
:::

:::info

**Declaration**
```c
void sendToLowerMac(uint16_t msgType, 
                    uint32_t msgLen, 
                    void *msg)
```

**Functionality**
Sends message to LowerMac

**Parameters**

| Parameter | Type | Description |
| --------- | ---- | ----------- |
|msgType|uint16_t|This parameter defines the message type based on the header that we already filled on the message type
|msgLen|uint32_t|The length of the message |
|*msg |  | Pointer to the received message from the PHY layer|

**Return Value**
None

:::
### 5. `fapiEvtHdlr` (Task)
> File Directory :.\odu_l2\l2\src\5gnrmac\lwr_mac_fsm.c

:::success
**Specific Information**
This is the task that will be done based on the event. For this message, the event is the PARAM Response Event.
:::

:::info

**Declaration**
```c
lwrMacFsmHdlr fapiEvtHdlr[MAX_STATE][MAX_EVENT]
```

**Functionality**
Task to run the event

**Return Value**
This will call a specific procedure/function based on the message that we want to generate.

:::
### 6. `lwr_mac_procParamRspEvt` (function)
> File Directory : .\odu_l2\l2\src\5gnrmac\lwr_mac_fsm.c

:::success
**Specific Information**
This function will process the PARAM.response and send it from Lower MAC to MAC.
:::

:::info

**Declaration**
```c
void procPhyMessages(uint16_t msgType, 
                     uint32_t msgSize, 
                     void *msg)
```

**Functionality**
Processes message from PHY

**Parameters**

| Parameter | Type | Description |
| --------- | ---- | ----------- |
|*msg |  | Pointer to the received message from the PHY layer|

**Return Value**
* ROK    :arrow_right: success
* RFAILED    :arrow_right: failure

:::
### Message Sequence (MSC)
:::success
![](https://hackmd.io/_uploads/SJCFHsst3.png)

:::

## CONFIG.request
### 1. `l1HdlConfigReq` (Ending Procedure)
> File Directory : .\odu_l2\l2\src\phy_stub\phy_stub_msg_hdl.c

:::success
**Specific Information**
This function is the ending procedure that will handle the CONFIG.request message from l2 (MAC). This function will automatically call [`l1BldAndSndConfigRsp`](#1-l1BldAndSndConfigRsp-MainStarting-function) to initiate the [CONFIG.response](#CONFIGresponse) message.
:::

:::info

**Declaration**
```c
void l1HdlConfigReq(uint32_t msgLen, 
                    void *msg)
```

**Functionality**
Handles config request received from MAC

**Parameters**

| Field                 | Type     | Description|
| --------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
|msgLen| uint32_t | Message Length|
| *msg |  | Param request message pointer|


**Return Value**
None

:::

### 2. `l1ProcessFapiRequest` (procedure)
> File Directory :.\odu_l2\l2\src\phy_stub\phy_stub_msg_hdl.c

:::success
**Specific Information**
Basically this procedure is to choose what is the next procedure to handle  the message based on the msgType that we input on this procedure. Based on the PARAM.request message, this procedure will call `l1HdlConfigReq` procedure.
:::

:::info
**Declaration**
```c
void l1ProcessFapiRequest(uint8_t msgType, 
                          uint32_t msgLen, 
                          void *msg)
```
**Functionality**
Receives message from MAC and calls handler

**Parameters**
| Parameter | Type | Description |
| --------- | ---- | ----------- |
|msgType|uint8_t|This parameter defines the message type based on the header.|
|msgLen|uint32_t|The length of the message |
|*msg |  | Message pointer|

**Return Value**
None

:::

### 3. `LwrMacSendToL1` (function)
> File Directory : .\odu_l2\l2\src\5gnrmac\lwr_mac_phy.c

:::success
**Specific Information**
If we trace [`l1ProcessFapiRequest`](#2-l1ProcessFapiRequest-procedure1) backwards, that procedure is being called by `LwrMacSendToL1` procedure.
:::

:::info
**Declaration**
```c
uint8_t LwrMacSendToL1(void *msg)
```
**Functionality**
Send FAPI messages to Intel PHY/Phy stub

**Parameters**
| Parameter | Type | Description |
| --------- | ---- | ----------- |
|*msg |  | Message pointer|

**Return Value**
* ROK :arrow_right: Success
* RFAILED :arrow_right: Failure

:::

### 4. `lwr_mac_procConfigReqEvt`
> File Directory D.\odu_l2\l2\src\5gnrmac\lwr_mac_fsm.c

:::success
**Specific Information**
This procedure will send FAPI CONFIG req to PHY.
:::

:::info
**Declaration**
```c
uint8_t lwr_mac_procConfigReqEvt(void *msg)
```
**Functionality**
Sends FAPI Config Req to PHY

**Parameters**
| Parameter | Type | Description |
| --------- | ---- | ----------- |
|*msg|pointer|This is a pointer to a message|

**Return Value**
* ROK    :arrow_right: success
* RFAILED    :arrow_right: failure

:::


### 5. `fapiEvtHdlr` (Task)
> File Directory :.\odu_l2\l2\src\5gnrmac\lwr_mac_fsm.c

:::success
**Specific Information**
This is the task that will be done based on the event. For this message, the event is the CONFIG request Event.
:::

:::info

**Declaration**
```c
lwrMacFsmHdlr fapiEvtHdlr[MAX_STATE][MAX_EVENT]
```

**Functionality**
Task to run the event

**Return Value**
This will call a specific procedure/function based on the message that we want to generate.

:::
### Message Sequence (MSC)
:::success
![](https://hackmd.io/_uploads/ByPPICjt3.png)

:::
## CONFIG.response
### 1. `l1BldAndSndConfigRsp` (Main/Starting function)
> File Directory : .\odu_l2\l2\src\phy_stub\phy_stub_msg_hdl.c

:::success
**Specific Information**
This function is the starting function of this message. This function is automatically called by [`l1HdlConfigReq`](#1-l1HdlConfigReq-Ending-Procedure)
:::

:::info

**Declaration**
```c
S16 l1BldAndSndConfigRsp(void *msg)
```

**Functionality**
Builds and sends config response to MAC 

**Parameters**

| Field                 | Type     | Description|
| --------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| *msg |  | config response message pointer|


**Return Value**
None
:::


### 2. `procPhyMessages` (function)
> File Directory : .\odu_l2\l2\src\5gnrmac\lwr_mac_handle_phy.c

:::success
**Specific Information**
This function will process the message from PHY.
:::

:::info

**Declaration**
```c
void procPhyMessages(uint16_t msgType, 
                     uint32_t msgSize, 
                     void *msg)
```

**Functionality**
Processes message from PHY

**Parameters**

| Parameter | Type | Description |
| --------- | ---- | ----------- |
|msgType|uint16_t|This parameter defines the message type based on the header that we already filled on the message type
|msgSize|uint32_t|The size of the message |
|*msg |  | Pointer to the received message from the PHY layer|

**Return Value**
* ROK    :arrow_right: success
* RFAILED    :arrow_right: failure

:::
### 3. `sendToLowerMac` (procedure)
> File Directory : .\odu_l2\l2\src\5gnrmac\lwr_mac_fsm.c

:::success
**Specific Information**
This function will send the message to the LowerMac
:::

:::info

**Declaration**
```c
void sendToLowerMac(uint16_t msgType, 
                    uint32_t msgLen, 
                    void *msg)
```

**Functionality**
Sends message to LowerMac

**Parameters**

| Parameter | Type | Description |
| --------- | ---- | ----------- |
|msgType|uint16_t|This parameter defines the message type based on the header that we already filled on the message type
|msgLen|uint32_t|The length of the message |
|*msg |  | Pointer to the received message from the PHY layer|

**Return Value**
None

:::
### 4. `fapiEvtHdlr` (Task)
> File Directory :.\odu_l2\l2\src\5gnrmac\lwr_mac_fsm.c

:::success
**Specific Information**
This is the task that will be done based on the event. For this message, the event is the CONFIG Response Event.
:::

:::info

**Declaration**
```c
lwrMacFsmHdlr fapiEvtHdlr[MAX_STATE][MAX_EVENT]
```

**Functionality**
Task to run the event

**Return Value**
This will call a specific procedure/function based on the message that we want to generate.

:::
### 5. `lwr_mac_procConfigRspEvt` (function)
> File Directory : .\odu_l2\l2\src\5gnrmac\lwr_mac_fsm.c

:::success
**Specific Information**
This function will process the CONFIG.response and send it from Lower MAC to MAC.
:::

:::info

**Declaration**
```c
void procPhyMessages(uint16_t msgType, 
                     uint32_t msgSize, 
                     void *msg)
```

**Functionality**
Processes message from PHY

**Parameters**

| Parameter | Type | Description |
| --------- | ---- | ----------- |
|*msg |  | Pointer to the received message from the PHY layer|

**Return Value**
* ROK    :arrow_right: success
* RFAILED    :arrow_right: failure

:::
### Message Sequence (MSC)
:::success
![](https://hackmd.io/_uploads/rkAeaCjF3.png)

:::
## START.request
### 1. `l1HdlStartReq` (Ending Procedure)
> File Directory : .\odu_l2\l2\src\phy_stub\phy_stub_msg_hdl.c

:::success
**Specific Information**
This function is the ending procedure that will handle the START.request message from l2 (MAC). This function will automatically call `l1HdlSlotIndication` to initiate the [SLOT.indication](#SLOTindication) message.
:::

:::info

**Declaration**
```c
void l1HdlStartReq(uint32_t msgLen, 
                    void *msg)
```

**Functionality**
Handles start request received from MAC

**Parameters**

| Field                 | Type     | Description|
| --------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
|msgLen| uint32_t | Message Length|
| *msg |  | Param request message pointer|


**Return Value**
None

:::

### 2. `l1ProcessFapiRequest` (procedure)
> File Directory :.\odu_l2\l2\src\phy_stub\phy_stub_msg_hdl.c

:::success
**Specific Information**
Basically this procedure is to choose what is the next procedure to handle  the message based on the msgType that we input on this procedure. Based on the PARAM.request message, this procedure will call `l1HdlStartReq` procedure.
:::

:::info
**Declaration**
```c
void l1ProcessFapiRequest(uint8_t msgType, 
                          uint32_t msgLen, 
                          void *msg)
```
**Functionality**
Receives message from MAC and calls handler

**Parameters**
| Parameter | Type | Description |
| --------- | ---- | ----------- |
|msgType|uint8_t|This parameter defines the message type based on the header.|
|msgLen|uint32_t|The length of the message |
|*msg |  | Message pointer|

**Return Value**
None

:::

### 3. `LwrMacSendToL1` (function)
> File Directory : .\odu_l2\l2\src\5gnrmac\lwr_mac_phy.c

:::success
**Specific Information**
If we trace [`l1ProcessFapiRequest`](#2-l1ProcessFapiRequest-procedure2) backwards, that procedure is being called by `LwrMacSendToL1` procedure.
:::

:::info
**Declaration**
```c
uint8_t LwrMacSendToL1(void *msg)
```
**Functionality**
Send FAPI messages to Intel PHY/Phy stub

**Parameters**
| Parameter | Type | Description |
| --------- | ---- | ----------- |
|*msg |  | Message pointer|

**Return Value**
* ROK :arrow_right: Success
* RFAILED :arrow_right: Failure

:::

### 4. `lwr_mac_procStartReqEvt`
> File Directory D.\odu_l2\l2\src\5gnrmac\lwr_mac_fsm.c

:::success
**Specific Information**
This procedure will send FAPI START req to PHY.
:::

:::info
**Declaration**
```c
uint8_t lwr_mac_procStartReqEvt(void *msg)
```
**Functionality**
Sends FAPI Start Req to PHY

**Parameters**
| Parameter | Type | Description |
| --------- | ---- | ----------- |
|*msg|pointer|This is a pointer to a message|

**Return Value**
* ROK    :arrow_right: success
* RFAILED    :arrow_right: failure

:::


### 5. `fapiEvtHdlr` (Task)
> File Directory :.\odu_l2\l2\src\5gnrmac\lwr_mac_fsm.c

:::success
**Specific Information**
This is the task that will be done based on the event. For this message, the event is the START request Event.
:::

:::info

**Declaration**
```c
lwrMacFsmHdlr fapiEvtHdlr[MAX_STATE][MAX_EVENT]
```

**Functionality**
Task to run the event

**Return Value**
This will call a specific procedure/function based on the message that we want to generate.

:::
### Message Sequence (MSC)
:::success
![](https://hackmd.io/_uploads/SJqMy12tn.png)

:::
## START.response
This message is not yet developed based on the source code that I use.
## STOP.request
### 1. `l1HdlStopReq` (Ending Procedure)
> File Directory : .\odu_l2\l2\src\phy_stub\phy_stub_msg_hdl.c

:::success
**Specific Information**
This function is the ending procedure that will handle the STOP.request message from l2 (MAC). 
:::

:::info

**Declaration**
```c
S16 l1HdlStopReq(uint32_t msgLen, 
                 void *msg)
```

**Functionality**
Handles stop request received from MAC

**Parameters**

| Field                 | Type     | Description|
| --------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
|msgLen| uint32_t | Message Length|
| *msg |  | Param request message pointer|


**Return Value**
None

:::

### 2. `l1ProcessFapiRequest` (procedure)
> File Directory :.\odu_l2\l2\src\phy_stub\phy_stub_msg_hdl.c

:::success
**Specific Information**
Basically this procedure is to choose what is the next procedure to handle  the message based on the msgType that we input on this procedure. Based on the PARAM.request message, this procedure will call `l1HdlStopReq` procedure.
:::

:::info
**Declaration**
```c
void l1ProcessFapiRequest(uint8_t msgType, 
                          uint32_t msgLen, 
                          void *msg)
```
**Functionality**
Receives message from MAC and calls handler

**Parameters**
| Parameter | Type | Description |
| --------- | ---- | ----------- |
|msgType|uint8_t|This parameter defines the message type based on the header.|
|msgLen|uint32_t|The length of the message |
|*msg |  | Message pointer|

**Return Value**
None

:::

### 3. `LwrMacSendToL1` (function)
> File Directory : .\odu_l2\l2\src\5gnrmac\lwr_mac_phy.c

:::success
**Specific Information**
If we trace [`l1ProcessFapiRequest`](#2-l1ProcessFapiRequest-procedure2) backwards, that procedure is being called by `LwrMacSendToL1` procedure.
:::

:::info
**Declaration**
```c
uint8_t LwrMacSendToL1(void *msg)
```
**Functionality**
Send FAPI messages to Intel PHY/Phy stub

**Parameters**
| Parameter | Type | Description |
| --------- | ---- | ----------- |
|*msg |  | Message pointer|

**Return Value**
* ROK :arrow_right: Success
* RFAILED :arrow_right: Failure

:::

### Message Sequence (MSC)
:::success
![](https://hackmd.io/_uploads/HJcBMknth.png)

:::
## STOP.indication
### 1. `l1BuildAndSendStopInd` (Main/Starting function)
> File Directory : .\odu_l2\l2\src\phy_stub\phy_stub_msg_hdl.c

:::success
**Specific Information**
This function is the starting function of this message. This function will automatically activate the EVT_PHY_STUB_STOP_IND event.
:::

:::info

**Declaration**
```c
uint16_t l1BuildAndSendStopInd()
```

**Functionality**
Send the Stop indication Message to MAC

**Return Value**
None
:::

### 2. `procPhyMessages` (function)
> File Directory : .\odu_l2\l2\src\5gnrmac\lwr_mac_handle_phy.c

:::success
**Specific Information**
This function will process the message from PHY.
:::

:::info

**Declaration**
```c
void procPhyMessages(uint16_t msgType, 
                     uint32_t msgSize, 
                     void *msg)
```

**Functionality**
Processes message from PHY

**Parameters**

| Parameter | Type | Description |
| --------- | ---- | ----------- |
|msgType|uint16_t|This parameter defines the message type based on the header that we already filled on the message type
|msgSize|uint32_t|The size of the message |
|*msg |  | Pointer to the received message from the PHY layer|

**Return Value**
* ROK    :arrow_right: success
* RFAILED    :arrow_right: failure

:::

### 3. `procStopInd` (procedure)
> File Directory : .\odu_l2\l2\src\5gnrmac\lwr_mac_handle_phy.c

:::success
**General Information**
This function will handle the Stop Indication from PHY and sends to MAC. When done correctly, it will send "INFO  -->  LWR_MAC: PHY has moved to configured state" message.
:::

:::info
**Declaration**
```c
uint8_t procCrcInd(fapi_crc_ind_t  *fapiCrcInd)
```
**Functionality**
Handles Stop Indication received from PHY

**Return Value**
* ROK    :arrow_right: success
* RFAILED    :arrow_right: failure
:::

### Message Sequence (MSC)
:::success
![](https://hackmd.io/_uploads/B1_OXe3F3.png)

:::
# Important Note
1. Based on the `procPhyMessages` function. There are several message that is not yet developed. These messages are `ERROR.indication`, `SRS.indication`
2. For the `Error.indication` message, the source code just provided the struct enum for Error Code (shown below). This ErrorCode is defined in .\odu_l2\l2\src\5gnrmac\lwr_mac_phy.h file
```c=1
typedef enum
{
   MSG_OK,
   MSG_INVALID_STATE,
   MSG_INVALID_CONFIG,
   SFN_OUT_OF_SYNC,
   MSG_SLOT_ERR,
   MSG_BCH_MISSING,
   MSG_INVALID_SFN,
   MSG_UL_DCI_ERR,
   MSG_TX_ERR
}ErrorCode;
```
:::success
Click [here](https://hackmd.io/@fauzanmuhammad/phy_stub_code_tracing) for the previous part.

Click [here](https://hackmd.io/@fauzanmuhammad/phy_stub_datatypes) to check about the data types
:::
